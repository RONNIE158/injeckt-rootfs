name: Build and Inject RootFS in LXC Container

on:
  workflow_dispatch:

jobs:
  build:
    name: Build RootFS with LXC and Inject
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y wget lxc qemu-user-static

      - name: Create base directory
        run: |
          mkdir -p base

      - name: Download rootfs
        run: |
          wget https://images.linuxcontainers.org/images/debian/trixie/arm64/cloud/20250420_05:24/rootfs.tar.xz -O base/rootfs.tar.xz
          cp public-key.asc base/public-key.asc

      - name: Extract rootfs
        run: |
          mkdir -p rootfs
          tar -xf base/rootfs.tar.xz -C rootfs

      - name: Initialize LXD (if not already initialized)
        run: |
          if ! sudo lxd init --quiet; then
            echo "LXD already initialized, skipping..."
          fi

      - name: Create LXC container using custom rootfs
        run: |
          # Create LXC container with custom configuration
          sudo lxc storage create lxd-pool dir
          sudo lxc init debian trixie-container --empty
          sudo lxc config device add trixie-container root disk path=/ rootfs
          sudo lxc start trixie-container

      - name: Push rootfs into LXC container
        run: |
          sudo lxc exec trixie-container -- mkdir -p /rootfs
          sudo lxc exec trixie-container -- bash -c 'tar -xvf /build/sources/rootfs.tar.xz -C /rootfs'

      - name: Run Injection Script in LXC Container
        run: |
          sudo lxc exec trixie-container -- bash -c "
          cp /build/sources/public-key.asc /usr/share/keyrings/lindroid.asc;
          echo 'deb [signed-by=/usr/share/keyrings/lindroid.asc] https://repo.lindroid.org/repository/lindroid trixie main' > /etc/apt/sources.list.d/lindroid.list;
          apt update;
          apt install -y lindroid-quirks nano strace sudo sddm adduser locales desktop-base evtest kde-full kwin-wayland qtwayland5 maliit-keyboard sddm-theme-debian-breeze plasma-workspace firefox-esr drihybris iproute2 libpipewire-module-lindroid libcanberra-pulse pipewire-audio wireplumber pipewire-pulse pipewire-alsa pipewire-jack openssh-server;
          useradd -m -s /bin/bash lindroid;
          echo 'lindroid:lindroid' | chpasswd;
          echo 'PermitRootLogin no' >> /etc/ssh/sshd_config;
          echo 'Port 555' >> /etc/ssh/sshd_config;
          systemctl enable ssh;
          systemctl enable sddm;
          apt clean;
          "

      - name: Stop LXC container
        run: |
          sudo lxc stop trixie-container

      - name: Export and Compress Final RootFS
        run: |
          sudo lxc export trixie-container out/lindroid-custom-rootfs.tar.xz

      - name: Upload final RootFS as artifact
        uses: actions/upload-artifact@v4
        with:
          name: lindroid-custom-rootfs
          path: out/lindroid-custom-rootfs.tar.xz
          retention-days: 1
